# akangAI 项目概览文档

> 最后更新时间: 2024年3月12日

## 目录
- [项目简介](#项目简介)
- [项目发展历程](#项目发展历程)
- [系统架构](#系统架构)
- [核心功能](#核心功能)
  - [语音识别 (ASR)](#语音识别-asr)
  - [大语言模型 (LLM)](#大语言模型-llm)
  - [文本转语音 (TTS)](#文本转语音-tts)
  - [声音克隆](#声音克隆)
- [技术栈](#技术栈)
- [数据流程](#数据流程)
- [关键配置](#关键配置)
- [自动更新内容](#自动更新内容)
- [自动更新脚本](#自动更新脚本)
- [开发指南](#开发指南)
- [安全性考虑](#安全性考虑)
- [测试流程](#测试流程)
- [已知问题与解决方案](#已知问题与解决方案)
- [性能优化建议](#性能优化建议)

## 项目简介

akangAI是一个基于云服务的AI聊天机器人平台，集成了语音识别(ASR)、大语言模型(LLM)和文本转语音(TTS)功能，并支持声音克隆。系统由管理服务器、管理前端和Windows客户端组成，通过Socket.IO实现实时通信。

## 项目发展历程

| 日期 | 版本 | 主要更新 |
|------|------|---------|
| 2023年12月 | 0.1.0 | 项目初始化，基础架构搭建 |
| 2024年1月 | 0.2.0 | 集成Cloudflare Whisper语音识别 |
| 2024年2月 | 0.3.0 | 集成DeepSeek Qwen大语言模型 |
| 2024年2月中 | 0.4.0 | 集成Fish Audio TTS服务 |
| 2024年3月 | 0.5.0 | 添加声音克隆功能 |
| 2024年3月中 | 0.6.0 | 优化错误处理和日志系统 |

### API变更历史

| 日期 | API | 变更内容 |
|------|-----|---------|
| 2024年2月 | Fish Audio API | 从v0.9升级到v1.0，语音克隆接口变更 |
| 2024年3月 | Cloudflare API | 添加了新的语音识别模型选项 |
| 2024年3月中 | DeepSeek API | 更新模型版本至Qwen2.5-7B-Instruct |

## 系统架构

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│  Windows客户端  │◄────►│   管理服务器    │◄────►│ 第三方AI服务    │
│  (Electron)     │      │  (Node.js/Express)│      │ (Cloudflare/Fish)│
└─────────────────┘      └────────┬────────┘      └─────────────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │   管理前端     │
                         │   (Vue.js)     │
                         └─────────────────┘
```

### 详细系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Windows客户端                           │
├─────────────┬─────────────┬───────────────────┬────────────────┤
│ 音频录制模块 │ Socket客户端 │ 音频播放模块      │ 界面渲染模块    │
│(audio-recorder)│(socket-client)│(audio-player)    │(renderer)      │
└─────────────┴─────────────┴───────────────────┴────────────────┘
          │                 │                  │
          ▼                 ▼                  ▼
┌──────────────────────────────────────────────────────────────┐
│                     WebSocket通信(Socket.IO)                  │
└──────────────────────────────────────────────────────────────┘
          │                 │                  │
          ▼                 ▼                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                           管理服务器                             │
├──────────┬──────────┬──────────┬──────────┬──────────┬─────────┤
│  ASR服务  │  LLM服务 │  TTS服务 │ 声音克隆 │ 用户管理 │ 数据存储 │
│(services/asr)│(services/llm)│(services/tts)│(services/voice-clone)│(controllers/user)│(models/*) │
└──────────┴──────────┴──────────┴──────────┴──────────┴─────────┘
     │           │          │           │
     ▼           ▼          ▼           ▼
┌─────────────────────────────────────────────────────────────────┐
│                         第三方AI服务API                          │
├────────────────┬───────────────────┬────────────────────────────┤
│ Cloudflare API │ DeepSeek Qwen API │ Fish Audio API             │
│ (语音识别)      │ (大语言模型)      │ (语音合成/声音克隆)         │
└────────────────┴───────────────────┴────────────────────────────┘
```

### 模块依赖关系

```
          ┌───────────► services/asr.js ──────┐
          │                                   ▼
app.js ───┼───────────► services/llm.js ────► utils/api.js ───► 第三方API
          │                                   ▲
          └───────────► services/tts.js ──────┘
                             │
                             ▼
                      services/voice-clone.js
```

### 组件通信方式

| 组件间通信 | 通信方式 | 描述 |
|-----------|---------|------|
| 客户端 ↔ 服务器 | Socket.IO | 实时语音传输、状态更新 |
| 服务器 ↔ 第三方API | REST API | HTTP请求，使用axios或node-fetch |
| 客户端界面间 | IPC | Electron主进程与渲染进程间通信 |
| 服务器内部组件 | 模块导入 | CommonJS require机制 |

## 核心功能

### 语音识别 (ASR)
```pseudocode
// ASR流程
Client:
  1. 录制用户语音
  2. 发送音频数据到服务器

Server:
  1. 接收音频数据
  2. 调用Cloudflare Whisper API
  3. 返回识别文本
```

### 大语言模型 (LLM)
```pseudocode
// LLM流程
Server:
  1. 接收用户文本输入
  2. 构建提示词
  3. 调用DeepSeek Qwen模型
  4. 处理模型响应
  5. 返回生成文本
```

### 文本转语音 (TTS)
> 注意：TTS与声音克隆是两个不同的功能。TTS使用预设声音，而声音克隆需要先创建自定义声音模型。

```pseudocode
// TTS流程 - 使用预设声音
Server:
  1. 接收文本内容
  2. 选择预设声音（如alex、anna等）
  3. 调用TTS API（如Fish Audio API）
  4. 生成语音数据
  5. 返回音频流

Client:
  1. 接收音频流
  2. 播放合成语音
```

#### 不同平台的TTS实现
| 平台 | API端点 | 特点 | 支持的声音 |
|------|---------|------|------------|
| Fish Audio | https://api.siliconflow.cn/v1/audio/speech | 中文效果好，低延迟 | alex, anna, bella等8种声音 |
| Azure | https://[region].tts.speech.microsoft.com/... | 多语言支持，高稳定性 | 200+种声音 |
| ElevenLabs | https://api.elevenlabs.io/v1/text-to-speech | 情感表达丰富 | 30+种声音 |

### 声音克隆
> 声音克隆是一个独立功能，需要先收集语音样本并训练模型，然后才能用于TTS。

```pseudocode
// 声音克隆流程 - 第一阶段：创建声音模型（一次性操作）
1. 收集用户语音样本（通常需要3-5分钟的高质量录音）
2. 上传样本到声音克隆服务（如Fish Audio）
3. 服务器处理样本并训练自定义声音模型
4. 获取并存储自定义模型ID

// 声音克隆流程 - 第二阶段：使用克隆声音（日常使用）
1. 接收文本内容
2. 指定使用已创建的自定义声音模型ID
3. 调用支持自定义模型的TTS API
4. 返回使用克隆声音的音频数据
```

#### 不同平台的声音克隆实现
| 平台 | 样本要求 | 训练时间 | 特点 |
|------|---------|---------|------|
| Fish Audio | 3-5分钟清晰录音 | 10-30分钟 | 中文效果好，支持情感调整 |
| PlayHT | 1-3分钟录音 | 5-15分钟 | 快速训练，多语言支持 |
| ElevenLabs | 1分钟以上录音 | 10-20分钟 | 高度自然，支持多种语言 |

## 技术栈

<!-- AUTO-GENERATED-CONTENT:START -->
### 管理服务器
- **运行环境**: Node.js
- **Web框架**: Express
- **实时通信**: Socket.IO
- **数据库**: MySQL
- **API集成**: Axios, Node-Fetch
- **认证**: JWT, Bcrypt

### 管理前端
- **框架**: Vue.js 3
- **状态管理**: Pinia
- **UI**: Tailwind CSS
- **构建工具**: Vite
- **HTTP客户端**: Axios
- **WebSocket**: Socket.IO Client

### Windows客户端
- **框架**: Electron
- **通信**: Socket.IO Client
- **唯一标识**: UUID
<!-- AUTO-GENERATED-CONTENT:END -->

## 数据流程

### 标准对话流程
```
┌─────────┐    1.语音输入     ┌─────────┐    2.ASR请求     ┌─────────────┐
│  客户端  │─────────────────►│ 管理服务器│─────────────────►│ Cloudflare AI │
└─────────┘                  └─────────┘                  └─────────────┘
     ▲                            │                             │
     │                            │ 3.文本                      │
     │                            ▼                             │
     │                      ┌─────────┐    4.LLM请求     ┌─────────────┐
     │                      │ 管理服务器│─────────────────►│ DeepSeek Qwen │
     │                      └─────────┘                  └─────────────┘
     │                            │                             │
     │                            │ 5.回复文本                  │
     │                            ▼                             │
     │                      ┌─────────┐    6.TTS请求     ┌─────────────┐
     │                      │ 管理服务器│─────────────────►│  Fish Audio  │
     │                      └─────────┘                  └─────────────┘
     │                            │                             │
     │      8.播放语音            │ 7.音频数据                  │
     └────────────────────◄──────┘◄────────────────────────────┘
```

### 声音克隆流程
```
┌─────────┐    1.上传语音样本   ┌─────────┐    2.克隆请求    ┌─────────────┐
│  客户端  │─────────────────►│ 管理服务器│─────────────────►│  Fish Audio  │
└─────────┘                  └─────────┘                  └─────────────┘
     ▲                            │                             │
     │                            │                             │ 3.训练模型
     │                            │                             ▼
     │                            │                       ┌─────────────┐
     │                            │                       │ 训练声音模型 │
     │                            │                       └─────────────┘
     │                            │                             │
     │                            │ 4.模型ID                    │
     │                            ◄─────────────────────────────┘
     │                            │
     │      5.模型ID              │
     └────────────────────◄──────┘

// 使用克隆声音时
┌─────────┐    1.文本+模型ID    ┌─────────┐    2.TTS请求     ┌─────────────┐
│  客户端  │─────────────────►│ 管理服务器│─────────────────►│  Fish Audio  │
└─────────┘                  └─────────┘    (使用克隆模型)  └─────────────┘
     ▲                            │                             │
     │                            │                             │ 3.生成语音
     │                            │                             ▼
     │      5.播放语音            │ 4.音频数据                  │
     └────────────────────◄──────┘◄────────────────────────────┘
```